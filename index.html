<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventory App - 17 Digit Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body { background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        #reader { width: 100%; border-radius: 8px; overflow: hidden; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwkXOpAQZI3LaWy7trhiVu-szRrX8vdURRB8QIStB_KTlpopSFT3RClenwwyFOd33zC/exec";

        const Icons = {
            Package: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m16.5 9.4-9-5.19"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>,
            Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
            QrCode: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="5" height="5" x="3" y="3" rx="1"/><rect width="5" height="5" x="16" y="3" rx="1"/><rect width="5" height="5" x="3" y="16" rx="1"/><path d="M21 16h-3a2 2 0 0 0-2 2v3"/><path d="M21 21v.01"/><path d="M12 7v3a2 2 0 0 1-2 2H7"/><path d="M3 12h.01"/><path d="M12 3h.01"/><path d="M12 16v.01"/><path d="M16 12h1"/><path d="M21 12v.01"/><path d="M12 21v-1"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            FileDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 18v-6"/><path d="m9 15 3 3 3-3"/></svg>,
            Image: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
            Send: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        };

        function InventoryApp() {
            const [masterData, setMasterData] = useState([]);
            const [recordData, setRecordData] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [headerDetails, setHeaderDetails] = useState({ uniqueNumber: '', location: '', allottedQty: '' });
            const [isLocked, setIsLocked] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [addedItems, setAddedItems] = useState([]);
            const [showSuggestions, setShowSuggestions] = useState(false);
            const [isScanning, setIsScanning] = useState(false);
            const [scanningRowIndex, setScanningRowIndex] = useState(null);
            const reportRef = useRef(null);
            const scannerRef = useRef(null);

            useEffect(() => {
                const fetchData = async () => {
                    try {
                        const response = await fetch(WEB_APP_URL);
                        const data = await response.json();
                        if (data.master) setMasterData(data.master);
                        if (data.records) setRecordData(data.records);
                    } catch (error) { console.error("Error fetching data:", error); } 
                    finally { setIsLoading(false); }
                };
                fetchData();
            }, []);

            useEffect(() => {
                if(!headerDetails.uniqueNumber || recordData.length === 0) { setIsLocked(false); return; }
                const match = recordData.find(r => r.uniqueNo === headerDetails.uniqueNumber.toString());
                if (match) {
                    setHeaderDetails(prev => ({ ...prev, location: match.location, allottedQty: match.qty }));
                    setIsLocked(true);
                } else { setIsLocked(false); }
            }, [headerDetails.uniqueNumber, recordData]);

            const handleHeaderChange = (e) => {
                const { name, value } = e.target;
                if(isLocked && (name === 'location' || name === 'allottedQty')) return;
                setHeaderDetails(prev => ({ ...prev, [name]: value }));
            };

            useEffect(() => {
                if (searchQuery.length > 1 && masterData.length > 0) {
                    const filtered = masterData.filter(item => 
                        (item.frame && item.frame.toString().toLowerCase().includes(searchQuery.toLowerCase())) || 
                        (item.engine && item.engine.toString().toLowerCase().includes(searchQuery.toLowerCase()))
                    );
                    setSearchResults(filtered);
                    setShowSuggestions(true);
                } else { setSearchResults([]); setShowSuggestions(false); }
            }, [searchQuery, masterData]);

            // Camera Handler
            useEffect(() => {
                let html5QrCode;
                if (isScanning) {
                    html5QrCode = new Html5Qrcode("reader");
                    html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, 
                    (decodedText) => { handleScanSuccess(decodedText); html5QrCode.stop().then(() => setIsScanning(false)); }, 
                    () => {}).catch(err => { alert("Camera error: " + err); setIsScanning(false); setScanningRowIndex(null); });
                    scannerRef.current = html5QrCode;
                } else { if (scannerRef.current) { scannerRef.current.stop().catch(err => console.log(err)); scannerRef.current = null; } }
                return () => { if (scannerRef.current) scannerRef.current.stop().catch(err => console.log(err)); };
            }, [isScanning]);

            const handleScanSuccess = (text) => {
                // Fix: Battery Scan Crash - Ensure row exists
                if (scanningRowIndex !== null) {
                    if (addedItems[scanningRowIndex]) {
                        const newItems = [...addedItems]; 
                        newItems[scanningRowIndex].battery = text;
                        setAddedItems(newItems); 
                        alert(`Battery ${text} added.`);
                    } else {
                        alert("Error: Item row not found.");
                    }
                    setScanningRowIndex(null); 
                } 
                // Fix: Vehicle Scan Logic - Handles 17 digits well
                else {
                    const foundItem = masterData.find(item => 
                        (item.frame && item.frame.toString().trim().toLowerCase() === text.trim().toLowerCase()) || 
                        (item.engine && item.engine.toString().trim().toLowerCase() === text.trim().toLowerCase())
                    );
                    if (foundItem) { 
                        handleAddItem(foundItem); 
                        alert(`Matched: ${text}`); 
                    } else { 
                        alert(`Not Found: ${text}`); 
                        setSearchQuery(text); 
                    }
                }
            };

            const handleAddItem = (item) => {
                if (addedItems.find(i => i.frame === item.frame)) return alert("Item already added!");
                if (headerDetails.allottedQty && addedItems.length >= parseInt(headerDetails.allottedQty)) return alert(`Limit Reached! Max ${headerDetails.allottedQty}`);
                setAddedItems([...addedItems, { ...item, battery: '' }]); setSearchQuery(''); setShowSuggestions(false);
            };

            const handleRemoveItem = (index) => {
                const newItems = [...addedItems]; newItems.splice(index, 1); setAddedItems(newItems);
            };

            const handleBatteryChange = (index, value) => {
                const newItems = [...addedItems]; newItems[index].battery = value; setAddedItems(newItems);
            };

            // --- PDF Generation Logic (Optimized for 17 Digits) ---
            const createPDFDoc = () => {
                const { jsPDF } = window.jspdf;
                // Landscape mode to fit wide columns
                const doc = new jsPDF('l', 'mm', 'a4');
                
                doc.setFontSize(18); doc.text("Dispatch Report", 14, 20);
                doc.setFontSize(10);
                doc.text(`Unique No: ${headerDetails.uniqueNumber || '-'}`, 14, 30);
                doc.text(`Location: ${headerDetails.location || '-'}`, 14, 35);
                doc.text(`Qty: ${addedItems.length} / ${headerDetails.allottedQty || '-'}`, 14, 40);
                doc.text(`Date: ${new Date().toLocaleDateString()}`, 150, 30);
                
                const tableColumn = ["SN", "Frame No", "Engine No", "Battery", "Model", "Color", "MTOC"];
                const tableRows = addedItems.map((item, index) => [
                    index + 1, item.frame, item.engine, item.battery || '-', item.model, item.color, item.mtoc
                ]);
                
                // Specific column widths for 17-digit Frame/Engine
                doc.autoTable({ 
                    head: [tableColumn], 
                    body: tableRows, 
                    startY: 45,
                    theme: 'grid',
                    styles: { fontSize: 10, cellPadding: 3, overflow: 'linebreak' },
                    columnStyles: { 
                        0: { cellWidth: 15 }, // SN
                        1: { cellWidth: 55 }, // Frame No (55mm is enough for 17 chars)
                        2: { cellWidth: 45 }, // Engine No
                        3: { cellWidth: 35 }, // Battery
                        4: { cellWidth: 40 }, // Model
                        5: { cellWidth: 35 }, // Color
                        6: { cellWidth: 35 }  // MTOC
                    }
                });
                return doc;
            };

            const submitData = () => {
                if (addedItems.length === 0) return alert("No items to submit.");
                if (headerDetails.allottedQty && addedItems.length !== parseInt(headerDetails.allottedQty)) return alert(`Error: Quantity mismatch. Required: ${headerDetails.allottedQty}`);
                
                setIsSubmitting(true);
                
                const doc = createPDFDoc();
                const pdfBase64 = doc.output('datauristring').split(',')[1];

                const payload = {
                    uniqueNumber: headerDetails.uniqueNumber,
                    location: headerDetails.location,
                    allottedQty: headerDetails.allottedQty,
                    items: addedItems,
                    pdfBase64: pdfBase64
                };

                fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(() => {
                    alert("Data Sent & File Saved to Drive!");
                    setAddedItems([]); setHeaderDetails({ uniqueNumber: '', location: '', allottedQty: '' }); setIsLocked(false);
                })
                .catch(error => { console.error('Error:', error); alert("Failed to send data."); })
                .finally(() => setIsSubmitting(false));
            };

            return (
                <div className="min-h-screen bg-gray-100 p-2 sm:p-4 md:p-6 font-sans pb-24">
                    <div className="max-w-5xl mx-auto bg-white shadow-xl rounded-xl overflow-hidden border border-gray-200">
                        <div className="bg-blue-700 p-3 md:p-4 text-white flex justify-between items-center sticky top-0 z-30">
                            <h1 className="text-lg md:text-xl font-bold flex items-center gap-2"><Icons.Package /> Stock Dispatch</h1>
                            <span className="text-[10px] md:text-xs bg-blue-800 px-2 py-1 rounded whitespace-nowrap">{isLoading ? 'Loading...' : 'Online'}</span>
                        </div>
                        <div className="p-2 md:p-4 space-y-4">
                            {isScanning && (
                                <div className="fixed inset-0 bg-black bg-opacity-90 z-50 flex flex-col items-center justify-center p-4">
                                    <div className="text-white mb-4 font-bold text-lg">{scanningRowIndex !== null ? "Scan Battery" : "Scan Vehicle"}</div>
                                    <div id="reader" className="bg-white w-full max-w-sm"></div>
                                    <button onClick={() => { setIsScanning(false); setScanningRowIndex(null); }} className="mt-6 bg-red-600 text-white px-6 py-3 rounded-full flex gap-2 w-full max-w-xs justify-center font-bold text-lg"><Icons.X /> Close Camera</button>
                                </div>
                            )}
                            <div className="relative z-20 flex flex-col sm:flex-row gap-2">
                                <div className="relative flex-1">
                                    <span className="absolute left-3 top-3.5 text-gray-400"><Icons.Search /></span>
                                    <input type="text" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} placeholder="Scan/Type Frame..." className="w-full pl-10 pr-4 py-3 border rounded-lg focus:ring-2 ring-blue-500 outline-none shadow-sm" disabled={isLoading} />
                                </div>
                                <button onClick={() => { setScanningRowIndex(null); setIsScanning(true); }} className="bg-gray-800 text-white p-3 rounded-lg flex items-center justify-center gap-2 font-semibold shadow-md active:scale-95 transition-transform"><Icons.QrCode /> <span>Scan</span></button>
                                {showSuggestions && (
                                    <div className="absolute top-14 left-0 w-full bg-white border shadow-xl rounded-lg z-50 max-h-60 overflow-y-auto">
                                        {searchResults.map((item, idx) => (
                                            <div key={idx} onClick={() => handleAddItem(item)} className="p-3 hover:bg-blue-50 cursor-pointer border-b flex justify-between items-center active:bg-blue-100">
                                                <div><div className="font-bold text-gray-800">{item.frame}</div><div className="text-xs text-gray-500">{item.engine}</div></div><div className="text-blue-600"><Icons.Plus /></div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                            <hr className="border-gray-200" />
                            <div ref={reportRef} className="bg-white p-2 md:p-4 border rounded-lg shadow-sm">
                                <div className="mb-4 pb-4 border-b">
                                    <h2 className="text-center font-bold text-lg mb-4 text-gray-800">DISPATCH REPORT</h2>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                                        <div className="bg-gray-50 p-2 border rounded"><label className="text-[10px] md:text-xs text-gray-500 block uppercase tracking-wide">UNIQUE NO</label><input type="text" name="uniqueNumber" value={headerDetails.uniqueNumber} onChange={handleHeaderChange} className="w-full bg-transparent font-bold outline-none text-blue-700 text-base" placeholder="ID..." /></div>
                                        <div className={`p-2 border rounded ${isLocked ? 'bg-gray-100' : 'bg-gray-50'}`}><label className="text-[10px] md:text-xs text-gray-500 block uppercase tracking-wide">LOCATION {isLocked && 'ðŸ”’'}</label><input type="text" name="location" value={headerDetails.location} onChange={handleHeaderChange} className="w-full bg-transparent font-bold outline-none text-base" placeholder="Loc" readOnly={isLocked} /></div>
                                        <div className={`p-2 border rounded flex justify-between items-center ${isLocked ? 'bg-gray-100' : 'bg-gray-50'}`}><div><label className="text-[10px] md:text-xs text-gray-500 block uppercase tracking-wide">QTY {isLocked && 'ðŸ”’'}</label><input type="number" name="allottedQty" value={headerDetails.allottedQty} onChange={handleHeaderChange} className="w-20 bg-transparent font-bold outline-none text-base" placeholder="0" readOnly={isLocked} /></div><div className="text-lg font-bold text-gray-400">{addedItems.length}/-</div></div>
                                    </div>
                                </div>
                                <div className="overflow-x-auto -mx-2 md:mx-0">
                                    <table className="w-full text-sm text-left border-collapse print-table min-w-[600px]">
                                        <thead><tr className="bg-gray-100 text-gray-700 uppercase text-xs">
                                            <th className="border p-2 w-10 text-center whitespace-nowrap">SN</th>
                                            <th className="border p-2 whitespace-nowrap">Frame</th>
                                            <th className="border p-2 whitespace-nowrap">Engine</th>
                                            <th className="border p-2 bg-yellow-50 w-32 whitespace-nowrap">Battery</th>
                                            <th className="border p-2 whitespace-nowrap">Model</th>
                                            <th className="border p-2 whitespace-nowrap">Color</th>
                                            <th className="border p-2 whitespace-nowrap">MTOC</th>
                                            <th className="border p-2 noprint text-center whitespace-nowrap">Act</th>
                                        </tr></thead>
                                        <tbody>
                                            {addedItems.length > 0 ? addedItems.map((item, index) => (
                                                <tr key={index} className="hover:bg-gray-50">
                                                    <td className="border p-2 font-bold text-center">{index + 1}</td>
                                                    <td className="border p-2 font-semibold whitespace-nowrap">{item.frame}</td>
                                                    <td className="border p-2 text-gray-600 whitespace-nowrap">{item.engine}</td>
                                                    <td className="border p-1 bg-yellow-50"><div className="flex items-center gap-1"><input type="text" value={item.battery || ''} onChange={(e) => handleBatteryChange(index, e.target.value)} className="w-full bg-white border border-gray-300 rounded px-1 text-xs py-1 outline-none min-w-[80px]" placeholder="Opt" /><button onClick={() => { setScanningRowIndex(index); setIsScanning(true); }} className="noprint text-gray-600 hover:text-blue-600 p-1 shrink-0"><Icons.QrCode /></button></div></td>
                                                    <td className="border p-2 whitespace-nowrap">{item.model}</td>
                                                    <td className="border p-2 whitespace-nowrap">{item.color}</td>
                                                    <td className="border p-2 whitespace-nowrap">{item.mtoc}</td>
                                                    <td className="border p-2 noprint text-center"><button onClick={() => handleRemoveItem(index)} className="text-red-500 hover:bg-red-50 p-2 rounded-full"><Icons.Trash2 /></button></td>
                                                </tr>
                                            )) : <tr><td colSpan="8" className="text-center p-6 text-gray-400 italic">No items added.</td></tr>}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div className="grid grid-cols-1 gap-3 pb-4">
                                <button onClick={submitData} disabled={isSubmitting} className={`w-full text-white py-3.5 rounded-lg font-bold flex justify-center items-center gap-2 shadow-lg transition-transform active:scale-95 ${isSubmitting ? 'bg-green-400' : 'bg-green-600 hover:bg-green-700 active:bg-green-800'}`}><Icons.Send /> {isSubmitting ? 'Sending...' : 'Submit'}</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<InventoryApp />);
    </script>
</body>
</html>
